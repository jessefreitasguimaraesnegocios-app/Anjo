# üõ°Ô∏è ANJO DA GUARDA - GUIA COMPLETO DE DESENVOLVIMENTO

## üìã **√çNDICE**
1. [Vis√£o Geral](#-vis√£o-geral)
2. [Configura√ß√£o Inicial](#-configura√ß√£o-inicial)
3. [Funcionalidades Implementadas](#-funcionalidades-implementadas)
4. [Corre√ß√µes e Melhorias](#-corre√ß√µes-e-melhorias)
5. [PWA e Deploy](#-pwa-e-deploy)
6. [Troubleshooting](#-troubleshooting)
7. [Estrutura do Projeto](#-estrutura-do-projeto)

---

## üéØ **VIS√ÉO GERAL**

### **O que √© o Anjo da Guarda?**
Aplicativo de seguran√ßa completo com grava√ß√£o de v√≠deo, √°udio e localiza√ß√£o em tempo real, desenvolvido como PWA (Progressive Web App) para funcionar nativamente em dispositivos m√≥veis e desktop.

### **Tecnologias Utilizadas:**
- **Frontend**: React + TypeScript + Vite
- **UI**: Shadcn/ui + Tailwind CSS
- **Backend**: Supabase (Auth + Database + Storage)
- **Estado**: React Query + Zustand
- **PWA**: Service Workers + Manifest
- **HTTPS**: Certificados SSL com mkcert

---

## üöÄ **CONFIGURA√á√ÉO INICIAL**

### **1. Pr√©-requisitos:**
```bash
# Node.js 18+
node --version

# npm ou yarn
npm --version
```

### **2. Instala√ß√£o:**
```bash
# Clone o reposit√≥rio
git clone https://github.com/seu-usuario/anjo-da-guarda.git
cd anjo-da-guarda

# Instale as depend√™ncias
npm install

# Configure HTTPS (opcional para desenvolvimento)
npm install -g mkcert
mkcert create-ca
mkcert create-cert --domains localhost,192.168.18.94,127.0.0.1
certutil -addstore -user Root ca.crt
```

### **3. Configura√ß√£o do Supabase:**

#### **A. Criar Projeto:**
1. Acesse [Supabase Dashboard](https://supabase.com/dashboard)
2. Crie um novo projeto
3. Anote a URL e chave anon

#### **B. Executar SQL:**
Execute o arquivo `database_schema.sql` no SQL Editor do Supabase:

```sql
-- Tabelas principais
CREATE TABLE public.profiles (
  id uuid REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
  full_name text,
  email text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

CREATE TABLE public.devices (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users on delete cascade not null,
  name text not null,
  type text not null check (type in ('phone', 'pc', 'tablet')),
  is_third_party boolean default false,
  third_party_email text,
  records_password text,
  recording_time_limit integer default 1 check (recording_time_limit >= 1 and recording_time_limit <= 60),
  status text default 'offline' check (status in ('online', 'offline')),
  last_seen timestamp with time zone,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

CREATE TABLE public.recordings (
  id uuid default uuid_generate_v4() primary key,
  device_id uuid references public.devices on delete cascade not null,
  user_id uuid references auth.users on delete cascade not null,
  type text not null check (type in ('video', 'audio', 'location', 'panic')),
  file_path text,
  location_data jsonb,
  duration integer,
  size integer,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  is_downloaded boolean default false
);

CREATE TABLE public.subscriptions (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references auth.users on delete cascade not null,
  plan text not null check (plan in ('trial', 'basic', 'premium')),
  status text not null check (status in ('active', 'cancelled', 'expired')),
  expires_at timestamp with time zone,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Bucket para grava√ß√µes
INSERT INTO storage.buckets (id, name, public)
VALUES ('recordings', 'recordings', false);

-- Pol√≠ticas RLS
CREATE POLICY "Users can view own profile" ON public.profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update own profile" ON public.profiles FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Users can view own devices" ON public.devices FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own devices" ON public.devices FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own devices" ON public.devices FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own devices" ON public.devices FOR DELETE USING (auth.uid() = user_id);

CREATE POLICY "Users can view own recordings" ON public.recordings FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own recordings" ON public.recordings FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own recordings" ON public.recordings FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own recordings" ON public.recordings FOR DELETE USING (auth.uid() = user_id);

CREATE POLICY "Users can view own subscriptions" ON public.subscriptions FOR SELECT USING (auth.uid() = user_id);

-- Pol√≠ticas para Storage
CREATE POLICY "Users can upload their own recordings" ON storage.objects
FOR INSERT WITH CHECK (
  bucket_id = 'recordings' 
  AND auth.uid()::text = (storage.foldername(name))[1]
);

CREATE POLICY "Users can view their own recordings" ON storage.objects
FOR SELECT USING (
  bucket_id = 'recordings' 
  AND auth.uid()::text = (storage.foldername(name))[1]
);

CREATE POLICY "Users can delete their own recordings" ON storage.objects
FOR DELETE USING (
  bucket_id = 'recordings' 
  AND auth.uid()::text = (storage.foldername(name))[1]
);

CREATE POLICY "Users can update their own recordings" ON storage.objects
FOR UPDATE USING (
  bucket_id = 'recordings' 
  AND auth.uid()::text = (storage.foldername(name))[1]
);

-- Trigger para criar perfil automaticamente
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name, email)
  VALUES (new.id, new.raw_user_meta_data->>'full_name', new.email);
  
  INSERT INTO public.subscriptions (user_id, plan, status, expires_at)
  VALUES (new.id, 'trial', 'active', now() + interval '3 days');
  
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();
```

#### **C. Configurar URLs de Autentica√ß√£o:**
1. V√° em **Authentication ‚Üí URL Configuration**
2. Configure:
   - **Site URL**: `http://localhost:8080`
   - **Redirect URLs**: `http://localhost:8080/**`

#### **D. Vari√°veis de Ambiente:**
Crie `.env.local`:
```env
VITE_SUPABASE_URL=sua_url_do_supabase
VITE_SUPABASE_ANON_KEY=sua_chave_anonima_do_supabase
```

### **4. Executar o Projeto:**
```bash
npm run dev
```

---

## üéØ **FUNCIONALIDADES IMPLEMENTADAS**

### **1. Sistema de Autentica√ß√£o:**
- ‚úÖ **Cadastro/Login** com Supabase Auth
- ‚úÖ **Perfis de usu√°rio** autom√°ticos
- ‚úÖ **Trial de 3 dias** autom√°tico
- ‚úÖ **Logout** seguro

### **2. Grava√ß√£o de M√≠dia:**
- ‚úÖ **Bot√£o P√¢nico**: V√≠deo + √Åudio + Localiza√ß√£o simult√¢neos
- ‚úÖ **C√¢mera Individual**: V√≠deo sem √°udio
- ‚úÖ **√Åudio Individual**: Apenas microfone
- ‚úÖ **Localiza√ß√£o**: GPS + Endere√ßo + Mapa interativo
- ‚úÖ **Preview em tempo real** durante grava√ß√£o
- ‚úÖ **Controle de dura√ß√£o** (1-60 minutos)
- ‚úÖ **Grava√ß√µes n√£o cancel√°veis** at√© completar tempo

### **3. Sistema de Dispositivos:**
- ‚úÖ **Adicionar dispositivos** pr√≥prios e de terceiros
- ‚úÖ **Senha de registros** por dispositivo
- ‚úÖ **Tempo de grava√ß√£o** individual por dispositivo
- ‚úÖ **Status online/offline**
- ‚úÖ **Gerenciamento completo**

### **4. Armazenamento e Reprodu√ß√£o:**
- ‚úÖ **Upload para Supabase Storage** (arquivos reais)
- ‚úÖ **Pasta "Meus Registros"** protegida por senha
- ‚úÖ **Reprodu√ß√£o de v√≠deo/√°udio** em tempo real
- ‚úÖ **Download de arquivos** para dispositivo
- ‚úÖ **Confirma√ß√£o dupla** para deletar registros

### **5. Sistema de Notifica√ß√µes:**
- ‚úÖ **Sino animado** (verde/vermelho)
- ‚úÖ **Hist√≥rico de notifica√ß√µes** com dropdown
- ‚úÖ **Posicionamento inteligente** (mobile: para cima)
- ‚úÖ **Substitui√ß√£o completa** dos toasts

### **6. Interface Responsiva:**
- ‚úÖ **Design mobile-first**
- ‚úÖ **Navega√ß√£o intuitiva**
- ‚úÖ **Componentes Shadcn/ui**
- ‚úÖ **Tema escuro/claro**

---

## üîß **CORRE√á√ïES E MELHORIAS**

### **1. Problema das Grava√ß√µes (50 bytes):**
**Problema**: Arquivos salvavam apenas metadados simulados
**Solu√ß√£o**: 
- Implementado upload real para Supabase Storage
- Corrigido c√°lculo de dura√ß√£o e tamanho
- Adicionado logs de debug para diagn√≥stico

### **2. Erro de Reprodu√ß√£o (StorageUnknownError):**
**Problema**: Arquivos n√£o encontrados no Storage
**Solu√ß√£o**:
- Adicionado verifica√ß√£o de exist√™ncia de arquivos
- Tratamento de grava√ß√µes antigas sem arquivo
- Logs detalhados para diagn√≥stico

### **3. Sistema de Notifica√ß√µes:**
**Problema**: Toasts intrusivos
**Solu√ß√£o**:
- Implementado sino animado personalizado
- Hist√≥rico de notifica√ß√µes com dropdown
- Posicionamento inteligente para mobile

### **4. Controle de Tempo de Grava√ß√£o:**
**Problema**: Grava√ß√µes cancel√°veis
**Solu√ß√£o**:
- Slider de 1-60 minutos na tela principal
- Slider individual por dispositivo
- Grava√ß√µes n√£o cancel√°veis at√© completar tempo

### **5. Prote√ß√£o de Arquivos:**
**Problema**: Arquivos essenciais delet√°veis
**Solu√ß√£o**:
- Pasta "Meus Registros" protegida por senha
- Confirma√ß√£o dupla para deletar
- Separa√ß√£o entre arquivos p√∫blicos e privados

---

## üì± **PWA E DEPLOY**

### **1. Configura√ß√£o PWA:**
- ‚úÖ **Manifest.json** configurado
- ‚úÖ **Service Worker** com cache offline
- ‚úÖ **√çcones PWA** gerados automaticamente
- ‚úÖ **Instala√ß√£o nativa** em dispositivos

### **2. Instala√ß√£o no Celular:**
**Android (Chrome)**:
1. Acesse `https://192.168.18.94:8080`
2. Aguarde prompt de instala√ß√£o
3. Clique "Instalar"

**iOS (Safari)**:
1. Acesse o site
2. Toque no bot√£o compartilhar
3. Selecione "Adicionar √† Tela Inicial"

### **3. Deploy Produ√ß√£o:**
```bash
# Build para produ√ß√£o
npm run build

# Deploy na Vercel
npm install -g vercel
vercel --prod

# Ou upload da pasta dist/ para Netlify/GitHub Pages
```

---

## üîç **TROUBLESHOOTING**

### **1. Problemas de Grava√ß√£o:**
**Sintoma**: Arquivos com 50 bytes
**Solu√ß√£o**: 
1. Execute `VERIFICAR_SUPABASE_CORRIGIDO.sql`
2. Verifique se bucket 'recordings' existe
3. Confirme pol√≠ticas RLS ativas
4. Teste nova grava√ß√£o com logs ativos

### **2. Erro de Reprodu√ß√£o:**
**Sintoma**: StorageUnknownError
**Solu√ß√£o**:
1. Verifique console para logs de upload/download
2. Confirme se arquivo existe no Supabase Storage
3. Teste bot√£o de download
4. Verifique pol√≠ticas RLS

### **3. Problemas de Autentica√ß√£o:**
**Sintoma**: "requested path is invalid"
**Solu√ß√£o**:
1. Verifique URLs de redirect no Supabase
2. Confirme vari√°veis de ambiente
3. Teste em modo inc√≥gnito

### **4. PWA n√£o Instala:**
**Sintoma**: Prompt n√£o aparece
**Solu√ß√£o**:
1. Use HTTPS obrigat√≥rio
2. Verifique manifest.json
3. Confirme Service Worker ativo
4. Teste em dispositivo real

### **5. Problemas de Compila√ß√£o:**
**Sintoma**: Erros de sintaxe
**Solu√ß√£o**:
1. Reinicie servidor: `npm run dev`
2. Limpe cache: `npm run build`
3. Verifique console para erros espec√≠ficos
4. Confirme imports corretos

---

## üìÅ **ESTRUTURA DO PROJETO**

```
anjo-da-guarda/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/                 # Componentes Shadcn/ui
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthForm.tsx        # Formul√°rio de login/cadastro
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Navigation.tsx      # Navega√ß√£o principal
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NotificationBell.tsx # Sistema de notifica√ß√µes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PWAInstallPrompt.tsx # Instala√ß√£o PWA
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.ts          # Hook de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useDevices.ts       # Hook de dispositivos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useRecordings.ts    # Hook de grava√ß√µes
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ usePWA.ts           # Hook PWA
‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Home.tsx            # Tela principal (grava√ß√µes)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Evidencias.tsx      # Evid√™ncias e arquivos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MeusRegistros.tsx   # Pasta protegida
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dispositivos.tsx    # Gerenciamento de dispositivos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Planos.tsx          # Planos e assinaturas
‚îÇ   ‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabase/           # Configura√ß√£o Supabase
‚îÇ   ‚îî‚îÄ‚îÄ lib/
‚îÇ       ‚îî‚îÄ‚îÄ utils.ts            # Utilit√°rios
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ manifest.json           # Manifest PWA
‚îÇ   ‚îú‚îÄ‚îÄ sw.js                   # Service Worker
‚îÇ   ‚îî‚îÄ‚îÄ icons/                  # √çcones PWA
‚îú‚îÄ‚îÄ database_schema.sql         # Schema do banco
‚îî‚îÄ‚îÄ README.md                   # Este arquivo
```

---

## üéØ **COMANDOS √öTEIS**

```bash
# Desenvolvimento
npm run dev              # Servidor de desenvolvimento
npm run build            # Build para produ√ß√£o
npm run preview          # Preview do build
npm run lint             # Linting do c√≥digo

# PWA
npm run generate-icons   # Gerar √≠cones PWA
npm run pwa:audit        # Auditoria PWA com Lighthouse

# Supabase
# Execute os SQLs necess√°rios no dashboard
```

---

## üöÄ **PR√ìXIMOS PASSOS**

### **Melhorias Futuras:**
- [ ] **Notifica√ß√µes Push** em tempo real
- [ ] **Backup na Nuvem** autom√°tico
- [ ] **Modo Stealth** (interface oculta)
- [ ] **Integra√ß√£o com Pol√≠cia** (envio autom√°tico)
- [ ] **IA para An√°lise** (detec√ß√£o de situa√ß√µes de risco)
- [ ] **Grava√ß√µes Persistentes** (continuam entre telas)
- [ ] **Sincroniza√ß√£o Multi-dispositivo**

### **Deploy Produ√ß√£o:**
- [ ] **Configurar HTTPS** em produ√ß√£o
- [ ] **Otimizar Service Worker** para produ√ß√£o
- [ ] **Configurar push notifications** com VAPID
- [ ] **Testar em dispositivos reais**
- [ ] **Configurar CI/CD** com GitHub Actions

---

## üìû **SUPORTE**

### **Problemas Comuns:**
1. **Grava√ß√µes n√£o salvam**: Verifique Supabase Storage
2. **PWA n√£o instala**: Use HTTPS obrigat√≥rio
3. **Erro de autentica√ß√£o**: Verifique URLs de redirect
4. **Arquivos n√£o reproduzem**: Confirme pol√≠ticas RLS

### **Logs de Debug:**
- **Console do navegador**: F12 ‚Üí Console
- **Network tab**: Para verificar requisi√ß√µes
- **Application tab**: Para verificar Service Worker

---

**üõ°Ô∏è O Anjo da Guarda est√° pronto para proteger!**

Este guia cont√©m todas as informa√ß√µes necess√°rias para entender, configurar, usar e manter o aplicativo. Para d√∫vidas espec√≠ficas, consulte as se√ß√µes relevantes ou verifique os logs de debug.

